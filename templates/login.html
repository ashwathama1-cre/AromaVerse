{% extends "base.html" %}
{% block title %}Login | AromaVerse{% endblock %}

{% block content %}
<style>
  body {
    background: url("{{ url_for('static', filename='login-bg.jpg') }}") no-repeat center center fixed;
    background-size: cover;
  }
  .bg-overlay {
    background-color: rgba(255, 255, 255, 0.9);
    backdrop-filter: blur(4px);
  }
  .toggle-btns .btn {
    width: 50%;
  }
</style>

<div class="d-flex align-items-center justify-content-center vh-100 bg-overlay">
  <div class="login-card col-md-5 col-sm-10 bg-white shadow rounded-4 p-4">
    <div class="text-center mb-3">
      <i class="bi bi-person-circle display-4 text-primary"></i>
      <h3 class="mt-2">Login to AromaVerse</h3>
    </div>

    <!-- Flash messages -->
    {% with messages = get_flashed_messages(with_categories=true) %}
      {% if messages %}
        {% for category, message in messages %}
          <div class="alert alert-{{ category }} text-center">{{ message }}</div>
        {% endfor %}
      {% endif %}
    {% endwith %}

    <!-- Login Form -->
    <form method="POST" action="{{ url_for('login') }}">
      {{ form.hidden_tag() }}
      <input type="hidden" name="mode" id="loginMode" value="password">

      <!-- Mode toggler -->
      <div class="toggle-btns d-flex mb-3">
        <button type="button" class="btn btn-outline-primary active" onclick="toggleMode('password')">ğŸ” Password</button>
        <button type="button" class="btn btn-outline-secondary" onclick="toggleMode('otp')">ğŸ“² OTP</button>
      </div>

      <!-- Password Login Fields -->
      <div id="passwordFields">
        <div class="mb-3">
          {{ form.username.label(class="form-label") }}
          {{ form.username(class="form-control", placeholder="Enter your username") }}
        </div>
        <div class="mb-3">
          {{ form.password.label(class="form-label") }}
          {{ form.password(class="form-control", placeholder="Enter your password") }}
        </div>
      </div>

      <!-- OTP Login Fields -->
      <div id="otpFields" style="display: none;">
        <div class="mb-3">
          <label for="countryCode" class="form-label">ğŸŒ Country Code</label>
          <input type="text" id="countryCode" class="form-control" placeholder="+91" value="+91">
        </div>
        <div class="mb-3">
          <label for="phone" class="form-label">ğŸ“ Phone Number</label>
          <input type="text" name="phone" id="phone" class="form-control" placeholder="Enter phone number">
        </div>
        <div class="mb-3 d-flex">
          <input type="text" name="otp" class="form-control me-2" placeholder="Enter OTP">
          <button type="button" class="btn btn-outline-success" onclick="sendOTP()">ğŸ“¤ Send OTP</button>
        </div>
      </div>

      <!-- Remember Me -->
      <div class="form-check mb-3">
        {{ form.remember(class="form-check-input", id="rememberMe") }}
        <label class="form-check-label" for="rememberMe">Remember Me</label>
      </div>

      <!-- Submit Button -->
      <button type="submit" class="btn btn-primary w-100">ğŸ”“ Login</button>
    </form>

    <!-- Links -->
    <div class="mt-3 d-flex justify-content-between">
      <a href="{{ url_for('register') }}" class="text-decoration-none">
        <i class="bi bi-person-plus-fill"></i> Sign up
      </a>
      <a href="{{ url_for('forgot_password') }}" class="text-decoration-none">
        <i class="bi bi-question-circle"></i> Forgot Password?
      </a>
    </div>
  </div>
</div>

<!-- Meta tag for CSRF -->
<meta name="csrf-token" content="{{ csrf_token() }}">

<!-- Scripts -->
<script>
  function getCSRFToken() {
    return document.querySelector('meta[name="csrf-token"]').getAttribute('content');
  }

  function toggleMode(mode) {
    document.getElementById("loginMode").value = mode;
    document.getElementById("passwordFields").style.display = (mode === 'password') ? 'block' : 'none';
    document.getElementById("otpFields").style.display = (mode === 'otp') ? 'block' : 'none';

    const buttons = document.querySelectorAll(".toggle-btns .btn");
    buttons.forEach(btn => btn.classList.remove("active"));
    if (mode === 'password') {
      buttons[0].classList.add("active");
    } else {
      buttons[1].classList.add("active");
    }
  }

  function sendOTP() {
    const phone = document.getElementById("phone").value.trim();
    const countryCode = document.getElementById("countryCode").value.trim();

    if (!phone || !countryCode) {
      alert("Please enter both phone number and country code.");
      return;
    }

    fetch("{{ url_for('send_otp_phone') }}", {
      method: "POST",
      headers: {
        "Content-Type": "application/json",
        "X-CSRFToken": getCSRFToken()
      },
      body: JSON.stringify({
        method: "phone",
        contact: phone,
        country_code: countryCode
      })
    })
    .then(response => response.json())
    .then(data => {
      alert(data.message || "OTP sent!");
    })
    .catch(error => {
      console.error("Error sending OTP:", error);
      alert("Failed to send OTP.");
    });
  }
</script>
{% endblock %}
