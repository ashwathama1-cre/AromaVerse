{% extends "base.html" %}
{% block title %}Login | AromaVerse{% endblock %}

{% block content %}
<style>
  body {
    background: url("{{ url_for('static', filename='login-bg.jpg') }}") no-repeat center center fixed;
    background-size: cover;
  }
  .bg-overlay {
    background-color: rgba(255, 255, 255, 0.85);
    backdrop-filter: blur(4px);
  }
  .toggle-btns .btn {
    width: 50%;
  }
</style>

<div class="d-flex align-items-center justify-content-center vh-100 bg-overlay">
  <div class="login-card col-md-4 col-sm-10 bg-white shadow rounded-4 p-4">
    <div class="login-icon text-center">
      <i class="bi bi-person-circle display-4 text-primary mb-3"></i>
    </div>
    <h3 class="text-center mb-3">Login to AromaVerse</h3>

    {% with messages = get_flashed_messages(with_categories=true) %}
      {% if messages %}
        {% for category, message in messages %}
          <div class="alert alert-{{ category }} text-center">{{ message }}</div>
        {% endfor %}
      {% endif %}
    {% endwith %}

    <form method="POST" action="{{ url_for('login') }}">
      <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
      <input type="hidden" name="mode" id="loginMode" value="password">

      <div class="toggle-btns d-flex mb-3">
        <button type="button" class="btn btn-outline-primary active" onclick="toggleMode('password')">ğŸ” Password Login</button>
        <button type="button" class="btn btn-outline-secondary" onclick="toggleMode('otp')">ğŸ“² OTP Login</button>
      </div>

      <!-- Password Login Fields -->
      <div id="passwordFields">
        <div class="mb-3">
          <label class="form-label">ğŸ‘¤ Username</label>
          <input type="text" name="username" class="form-control" placeholder="Enter your username">
        </div>
        <div class="mb-3">
          <label class="form-label">ğŸ”’ Password</label>
          <input type="password" name="password" class="form-control" placeholder="Enter your password">
        </div>
      </div>

      <!-- OTP Login Fields -->
      <div id="otpFields" style="display: none;">
        <div class="mb-3">
          <label class="form-label">ğŸŒ Country Code</label>
          <input type="text" id="countryCode" class="form-control" placeholder="+91">
        </div>
        <div class="mb-3">
          <label class="form-label">ğŸ“ Phone Number</label>
          <input type="text" name="phone" id="phone" class="form-control" placeholder="Enter phone number">
        </div>
        <div class="mb-3 d-flex">
          <input type="text" name="otp" class="form-control me-2" placeholder="Enter OTP">
          <button type="button" class="btn btn-outline-success" onclick="sendOTP()">ğŸ“¤ Send OTP</button>
        </div>
      </div>

      <div class="form-check mb-3">
        <input class="form-check-input" type="checkbox" name="remember" id="rememberMe">
        <label class="form-check-label" for="rememberMe">Remember Me</label>
      </div>

      <button type="submit" class="btn btn-primary w-100">ğŸ”“ Login</button>
    </form>

    <div class="mt-3 d-flex justify-content-between">
      <a href="{{ url_for('register') }}" class="text-decoration-none">
        <i class="bi bi-person-plus-fill"></i> Sign up
      </a>
      <a href="{{ url_for('forgot_password') }}" class="text-decoration-none">
        <i class="bi bi-question-circle"></i> Forgot Password?
      </a>
    </div>
  </div>
</div>

<script>
  function toggleMode(mode) {
    document.getElementById("loginMode").value = mode;
    document.getElementById("passwordFields").style.display = mode === 'password' ? 'block' : 'none';
    document.getElementById("otpFields").style.display = mode === 'otp' ? 'block' : 'none';

    const buttons = document.querySelectorAll(".toggle-btns .btn");
    buttons.forEach(btn => btn.classList.remove("active"));
    if (mode === 'password') {
      buttons[0].classList.add("active");
    } else {
      buttons[1].classList.add("active");
    }
  }

  function getCookie(name) {
    const cookies = document.cookie.split(';').map(c => c.trim());
    for (let c of cookies) {
      if (c.startsWith(name + '=')) return c.split('=')[1];
    }
    return null;
  }

  function sendOTP() {
    const phone = document.getElementById("phone").value.trim();
    const countryCode = document.getElementById("countryCode").value.trim();

    if (!phone || !countryCode) {
      alert("Please enter both phone number and country code.");
      return;
    }

    fetch("/send_otp_phone", {
      method: "POST",
      headers: {
        "Content-Type": "application/json",
        "X-CSRFToken": getCookie("csrf_token")
      },
      body: JSON.stringify({
        method: "phone",
        contact: phone,
        country_code: countryCode
      })
    })
    .then(response => response.json())
    .then(data => {
      alert(data.message || "OTP sent!");
    })
    .catch(error => {
      console.error("Error sending OTP:", error);
      alert("Failed to send OTP.");
    });
  }
</script>
{% endblock %}
