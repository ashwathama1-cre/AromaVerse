{% extends "base.html" %}
{% block title %}Admin Dashboard | AromaVerse{% endblock %}
{% block content %}
<div class="container py-4">
  <h2 class="mb-4">üìä Admin Dashboard</h2>

  <!-- Summary Cards -->
  <div class="row mb-4">
    <div class="col-md-3">
      <div class="card border-start border-success border-4 shadow-sm">
        <div class="card-body">
          <h6>Total Revenue</h6>
          <p class="fw-bold text-success">‚Çπ{{ "{:,.2f}".format(total_revenue) }}</p>
        </div>
      </div>
    </div>
    <div class="col-md-3">
      <div class="card border-start border-primary border-4 shadow-sm">
        <div class="card-body">
          <h6>Total Products</h6>
          <p class="fw-bold">{{ total_products }}</p>
        </div>
      </div>
    </div>
    <div class="col-md-3">
      <div class="card border-start border-warning border-4 shadow-sm">
        <div class="card-body">
          <h6>Total Quantity Sold</h6>
          <p class="fw-bold">{{ total_sold }}</p>
        </div>
      </div>
    </div>
    <div class="col-md-3">
      <div class="card border-start border-info border-4 shadow-sm">
        <div class="card-body">
          <h6>Total Sellers</h6>
          <p class="fw-bold">{{ total_sellers }}</p>
        </div>
      </div>
    </div>
  </div>

  <!-- Additional Stats -->
  <div class="row mb-4">
    <div class="col-md-6">
      <div class="card border-start border-primary border-4 shadow-sm">
        <div class="card-body">
          <h6>Total Products Left</h6>
          <p class="fw-bold text-primary">{{ total_unsold }}</p>
        </div>
      </div>
    </div>
    <div class="col-md-6">
      <div class="card border-start border-success border-4 shadow-sm">
        <div class="card-body">
          <h6>Admin Commission Earned</h6>
          <p class="fw-bold text-success">‚Çπ{{ commission }}</p>
        </div>
      </div>
    </div>
  </div>

  <!-- Action Buttons -->
  <div class="mb-4 d-flex flex-wrap gap-2">
    <a href="/sales_history" class="btn btn-outline-info">üïí View Sale History</a>
    <a href="/admin_charts" class="btn btn-outline-primary">üìä Seller Comparison</a>
    <a href="/manage_sellers" class="btn btn-outline-dark">üë§ Manage Sellers</a>
    <a href="/sell" class="btn btn-outline-success">‚ûï Add Product</a>
    <a href="/promote_list" class="btn btn-outline-warning">üîÅ Promote Buyer</a>
    <a href="/admin/product_stats" class="btn btn-outline-secondary">üìã View Product Stats</a>
    <a href="/admin/products_table" class="btn btn-outline-secondary">üñºÔ∏è View All Products</a>
    <a href="/change_password" class="btn btn-outline-danger">üîê Change Password</a>
    <a href="/admin/change_name" class="btn btn-outline-secondary">‚úèÔ∏è Change Name</a>
    <button class="btn btn-outline-primary" onclick="scrollToChart()">üìä View Chart</button>
  </div>

  <!-- Chart Section -->
  <div class="card mb-4" id="chart-section">
    <div class="card-header d-flex justify-content-between align-items-center">
      <div class="d-flex align-items-center gap-2">
        üìä Product Distribution Chart
        <label for="chartTypeSelector" class="me-2">Chart Type:</label>
        <select id="chartTypeSelector" class="form-select w-auto">
          <option value="">-- Choose Chart --</option>
          <option value="pie">Pie</option>
          <option value="bar">Bar</option>
           <option value="line">line</option>
          <option value="doughnut">Doughnut</option>
        </select>
      </div>
      <button class="btn btn-outline-info btn-sm" onclick="toggleProductDescription()">üì¶ View Product Description</button>
    </div>
    <div class="card-body">
      <div id="chartContainer" class="ratio ratio-1x1 d-none">
        <canvas id="productChart"></canvas>
      </div>
      <div id="productDescription" class="d-none mt-3">
        <table class="table table-bordered table-striped">
          <thead>
            <tr>
              <th>Image</th>
              <th>Name</th>
              <th>Type</th>
              <th>Description</th>
              <th>Seller</th>
              <th>Qty Left</th>
              <th>Qty Sold</th>
              <th>Price</th>
              <th>Revenue</th>
              <th>Commission</th>
            </tr>
          </thead>
          <tbody id="product-desc-body"></tbody>
        </table>
        <p class="mt-3 fw-bold text-success">
          Total Admin Commission from Products: ‚Çπ<span id="total-commission">0</span>
        </p>
      </div>
    </div>
  </div>

  <!-- Seller Overview Table -->
  <div class="card">
    <div class="card-header">üë§ Sellers Overview</div>
    <div class="card-body table-responsive">
      <table class="table table-hover">
        <thead>
          <tr>
            <th>Seller</th>
            <th>Email</th>
            <th>Total Products</th>
          </tr>
        </thead>
        <tbody>
          {% for seller in seller_data %}
          <tr onclick="openSellerDetail('{{ seller.id }}')" style="cursor:pointer;">

            <td>{{ seller.seller }}</td>
            <td>{{ seller.email }}</td>
            <td>{{ seller.product_count or 0 }}</td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
  </div>
</div>
<!-- Seller Detail Modal -->
<div class="modal fade" id="sellerModal" tabindex="-1">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Seller Details</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <p><strong>Name:</strong> <span id="modal-seller-name"></span></p>
        <p><strong>Email:</strong> <span id="modal-seller-email"></span></p>
        <p><strong>Total Products:</strong> <span id="modal-seller-products"></span></p>
        <p><strong>Total Sold:</strong> <span id="modal-seller-sold"></span></p>
        <p><strong>Revenue:</strong> ‚Çπ<span id="modal-seller-revenue"></span></p>
      </div>
    </div>
  </div>
</div>



<!-- Chart + Modal Script -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
  let chart;

  // Chart init
  const ctx = document.getElementById('productChart')?.getContext('2d');
  const labels = {{ chart_labels | safe }};
  const data = {{ chart_data | safe }};
  const chartTypeSelector = document.getElementById('chartTypeSelector');
  const chartContainer = document.getElementById('chartContainer');

  // Handle chart type change
  if (chartTypeSelector) {
    chartTypeSelector.addEventListener('change', function () {
      if (chart) chart.destroy();
      const selectedType = this.value;
      if (!selectedType) {
        chartContainer?.classList.add("d-none");
        return;
      }
      chartContainer?.classList.remove("d-none");

      chart = new Chart(ctx, {
        type: selectedType,
        data: {
          labels: labels,
          datasets: [{
            label: 'Product Count',
            data: data,
            backgroundColor: [
              '#4CAF50', '#2196F3', '#FFC107', '#FF5722',
              '#9C27B0', '#00BCD4', '#E91E63', '#3F51B5', '#795548'
            ],
            borderWidth: 1
          }]
        },
        options: {
          responsive: true,
          plugins: {
            legend: {
              position: selectedType === 'bar' ? 'top' : 'right'
            }
          }
        }
      });
    });
  }

  // Scroll to chart section
  function scrollToChart() {
    document.getElementById('chart-section')?.scrollIntoView({ behavior: 'smooth' });
  }

  // Toggle between chart and product description
  function toggleProductDescription() {
    const chartContainer = document.getElementById('chartContainer');
    const desc = document.getElementById('productDescription');
    const tableBody = document.getElementById('product-desc-body');

    if (!desc || !chartContainer || !tableBody) return;

    if (desc.classList.contains('d-none')) {
      chartContainer.classList.add('d-none');
      desc.classList.remove('d-none');

      fetch('/admin/products_json')
        .then(res => res.json())
        .then(products => {
          tableBody.innerHTML = '';
          let totalCommission = 0;

          products.forEach(p => {
            totalCommission += p.commission;
            tableBody.innerHTML += `
              <tr>
                <td><img src="${p.image || '/static/default.png'}" width="50"/></td>
                <td>${p.name}</td>
                <td>${p.type}</td>
                <td>${p.description || 'No description'}</td>
                <td>${p.seller}</td>
                <td>${p.left}</td>
                <td>${p.sold}</td>
                <td>‚Çπ${p.price}</td>
                <td>‚Çπ${p.revenue.toFixed(2)}</td>
                <td>‚Çπ${p.commission.toFixed(2)}</td>
              </tr>
            `;
          });

          const totalCommissionEl = document.getElementById("total-commission");
          if (totalCommissionEl) {
            totalCommissionEl.textContent = totalCommission.toFixed(2);
          }
        })
        .catch(err => {
          console.error("Failed to load product description data", err);
          alert("Error loading product info.");
        });

    } else {
      desc.classList.add('d-none');
      chartContainer.classList.remove('d-none');
    }
  }

  // Open seller modal on row click
  function openSellerDetail(sellerId) {
    if (!sellerId) return;
    fetch(`/admin/seller_detail/${sellerId}`)
      .then(res => {
        if (!res.ok) throw new Error("Seller fetch failed");
        return res.json();
      })
      .then(data => {
        console.log("Seller Data:", data);
        document.getElementById('modal-seller-name').textContent = data.name;
        document.getElementById('modal-seller-email').textContent = data.email;
        document.getElementById('modal-seller-products').textContent = data.total_products;
        document.getElementById('modal-seller-sold').textContent = data.total_sold;
        document.getElementById('modal-seller-revenue').textContent = data.revenue;

        const modal = new bootstrap.Modal(document.getElementById('sellerModal'));
        modal.show();
      })
      .catch(err => {
        console.error("Error loading seller info:", err);
        alert("Could not fetch seller details.");
      });
  }
</script>
{% endblock %}
