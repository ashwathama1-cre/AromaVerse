{% extends "base.html" %}
{% block title %}Verify OTP | Itra Store{% endblock %}

{% block content %}
<div class="container py-5">
  <div class="col-md-6 mx-auto bg-light p-4 rounded shadow">
    <h4 class="mb-3">ğŸ”’ OTP Verification</h4>
    <p class="text-muted">
      OTP sent to <strong>{{ session.get('otp_email')|replace('@', ' [at] ')|replace(session.get('otp_email')[1:-10], '*' * len(session.get('otp_email')[1:-10])) }}</strong><br>
      Valid for <span id="countdown">{{ time_left }}</span>.
    </p>

    <form method="POST" id="otpForm">
      {{ csrf_token() }}
      <div class="mb-3">
        <label for="otp">Enter OTP</label>
        <input type="text" name="otp" id="otp" class="form-control" required>
      </div>
      <button type="submit" id="submitBtn" class="btn btn-primary">âœ… Verify OTP</button>
      <button type="button" id="resendBtn" class="btn btn-warning mt-2" onclick="resendOTP()" disabled>
        ğŸ” Resend OTP <span id="spinner" class="spinner-border spinner-border-sm d-none"></span>
      </button>
    </form>
  </div>
</div>

<script>
  let seconds = parseInt(document.getElementById("countdown").innerText);
  const countdownDisplay = document.getElementById("countdown");
  const submitBtn = document.getElementById("submitBtn");
  const resendBtn = document.getElementById("resendBtn");
  const spinner = document.getElementById("spinner");

  let countdown = setInterval(() => {
    seconds--;
    let mins = Math.floor(seconds / 60);
    let secs = seconds % 60;
    countdownDisplay.innerText = `${String(mins).padStart(2, '0')}:${String(secs).padStart(2, '0')}`;
    if (seconds <= 0) {
      clearInterval(countdown);
      countdownDisplay.innerText = "00:00";
      submitBtn.disabled = true;
      resendBtn.disabled = false;
    }
  }, 1000);

  function resendOTP() {
    resendBtn.disabled = true;
    spinner.classList.remove('d-none');

    fetch("/resend_otp", {
      method: "POST",
      headers: {
        "Content-Type": "application/json",
        "X-CSRFToken": "{{ csrf_token() }}"
      },
      body: JSON.stringify({ email: "{{ session.get('otp_email') }}" })
    })
    .then(res => res.json())
    .then(data => {
      spinner.classList.add('d-none');
      if (data.status === "success") {
        alert("âœ… OTP resent to your email.");
        location.reload();
      } else {
        alert(`âŒ ${data.message}`);
        resendBtn.disabled = false;
      }
    });
  }
</script>
{% endblock %}
