{% extends "base.html" %}
{% block title %}Admin Dashboard | AromaVerse{% endblock %}
{% block content %}
<div class="container py-4">
  <h2 class="mb-4">ðŸ“Š Admin Dashboard</h2>

  <!-- Summary Cards -->
  <div class="row mb-4">
    <!-- ... (summary cards same as your version) -->
  </div>

  <!-- Extra Actions -->
  <div class="row row-cols-1 row-cols-md-3 g-4 mb-4">
    <!-- ... (admin action buttons same as your version) -->
  </div>

  <!-- Chart + Product Description -->
  <div class="card mb-4" id="chart-section">
    <div class="card-header d-flex justify-content-between align-items-center">
      <div class="d-flex align-items-center gap-2">
        ðŸ“Š Product Chart
        <label for="chartTypeSelector" class="me-2">Chart Type:</label>
        <select id="chartTypeSelector" class="form-select w-auto">
          <option value="">-- Select --</option>
          <option value="pie">Pie</option>
          <option value="bar">Bar</option>
          <option value="doughnut">Doughnut</option>
        </select>
      </div>
      <button class="btn btn-outline-info btn-sm" onclick="toggleProductDescription()">ðŸ“¦ View Product Description</button>
    </div>
    <div class="card-body">
      <div id="chartContainer" class="ratio ratio-1x1 d-none">
        <canvas id="productChart"></canvas>
      </div>
      <div id="productDescription" class="d-none mt-3">
        <table class="table table-bordered table-striped">
          <thead>
            <tr>
              <th>Image</th>
              <th>Name</th>
              <th>Type</th>
              <th>Description</th>
              <th>Seller</th>
              <th>Qty Left</th>
              <th>Qty Sold</th>
              <th>Price</th>
            </tr>
          </thead>
          <tbody id="product-desc-body"></tbody>
        </table>
      </div>
    </div>
  </div>

  <!-- Seller Table -->
  <div class="card">
    <div class="card-header">ðŸ‘¤ Sellers Overview</div>
    <div class="card-body table-responsive">
      <table class="table table-hover">
        <thead>
          <tr>
            <th>Seller</th>
            <th>Email</th>
            <th>Total Products</th>
          </tr>
        </thead>
        <tbody>
          {% for seller in seller_data %}
          <tr onclick="openSellerDetail('{{ seller.id }}')" style="cursor: pointer;">
            <td>{{ seller.seller }}</td>
            <td>{{ seller.email }}</td>
            <td>{{ seller.product_count or 0 }}</td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
  </div>
</div>

<!-- Seller Modal -->
<div class="modal fade" id="sellerModal" tabindex="-1" aria-labelledby="sellerModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="sellerModalLabel">Seller Details</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <p><strong>Name:</strong> <span id="modal-seller-name"></span></p>
        <p><strong>Email:</strong> <span id="modal-seller-email"></span></p>
        <p><strong>Total Products:</strong> <span id="modal-seller-products"></span></p>
        <p><strong>Total Sold:</strong> <span id="modal-seller-sold"></span></p>
        <p><strong>Revenue:</strong> â‚¹<span id="modal-seller-revenue"></span></p>
      </div>
    </div>
  </div>
</div>

<!-- Scripts -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
  let chart;
  const ctx = document.getElementById('productChart').getContext('2d');
  const labels = {{ chart_labels | safe }};
  const data = {{ chart_data | safe }};
  const chartTypeSelector = document.getElementById('chartTypeSelector');
  const chartContainer = document.getElementById('chartContainer');

  chartTypeSelector.addEventListener('change', function () {
    if (chart) chart.destroy();
    const selectedType = this.value;
    if (!selectedType) {
      chartContainer.classList.add("d-none");
      return;
    }
    chartContainer.classList.remove("d-none");
    chart = new Chart(ctx, {
      type: selectedType,
      data: {
        labels: labels,
        datasets: [{
          label: 'Product Count',
          data: data,
          backgroundColor: ['#4CAF50', '#2196F3', '#FFC107', '#FF5722', '#9C27B0', '#00BCD4', '#E91E63'],
          borderWidth: 1
        }]
      },
      options: {
        responsive: true,
        plugins: {
          legend: {
            position: selectedType === 'bar' ? 'top' : 'right'
          }
        }
      }
    });
  });

  function scrollToChart() {
    document.getElementById('chart-section').scrollIntoView({ behavior: 'smooth' });
  }

  function toggleProductDescription() {
    const chartContainer = document.getElementById('chartContainer');
    const desc = document.getElementById('productDescription');

    if (desc.classList.contains('d-none')) {
      chartContainer.classList.add('d-none');
      desc.classList.remove('d-none');

      fetch('/admin/products_json')
        .then(res => res.json())
        .then(products => {
          const body = document.getElementById('product-desc-body');
          body.innerHTML = '';
          products.forEach(p => {
            body.innerHTML += `
              <tr>
                <td><img src="${p.image}" width="50"/></td>
                <td>${p.name}</td>
                <td>${p.type}</td>
                <td>${p.description || 'No description'}</td>
                <td>${p.seller}</td>
                <td>${p.left}</td>
                <td>${p.sold}</td>
                <td>â‚¹${p.price}</td>
              </tr>
            `;
          });
        });
    } else {
      desc.classList.add('d-none');
      chartContainer.classList.remove('d-none');
    }
  }

  function openSellerDetail(sellerId) {
    fetch(`/admin/seller_detail/${sellerId}`)
      .then(res => res.json())
      .then(data => {
        document.getElementById('modal-seller-name').textContent = data.name;
        document.getElementById('modal-seller-email').textContent = data.email;
        document.getElementById('modal-seller-products').textContent = data.total_products;
        document.getElementById('modal-seller-sold').textContent = data.total_sold;
        document.getElementById('modal-seller-revenue').textContent = data.revenue;
        new bootstrap.Modal(document.getElementById('sellerModal')).show();
      })
      .catch(err => alert("Error fetching seller details"));
  }
</script>
{% endblock %}  
